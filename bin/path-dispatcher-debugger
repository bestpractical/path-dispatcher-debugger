#!/usr/bin/env perl
use strict;
use warnings;
use Path::Dispatcher::Debugger;
use HTTP::Engine;
use Scalar::Util 'blessed';

my $dispatcher = shift or die "usage: $0 Dispatcher::Class::Name";
if ($dispatcher =~ /^{/) {
    $dispatcher = eval $dispatcher;
}
else {
    Any::Moose::load_class($dispatcher);
}

unless (blessed($dispatcher) && $dispatcher->isa('Path::Dispatcher')) {
    if ($dispatcher->can('new')) {
        $dispatcher = $dispatcher->new;
    }
    else {
        $dispatcher = $dispatcher->dispatcher;
    }
}

my $port = 9187;
my $debugger = Path::Dispatcher::Debugger->new(
    dispatcher => $dispatcher,
);

HTTP::Engine->new(
    interface => {
        module => 'ServerSimple',
        args   => {
            host => 'localhost',
            port => $port,
        },
        request_handler => sub { $debugger->handle_request(@_) },
    },
)->run;

